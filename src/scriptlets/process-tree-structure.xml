<?xml version="1.0" encoding="UTF-8"?>
<scriptlet id="processTreeStructure" xmlns="http://www.gitb.com/tdl/v1/">
  <!-- Processes a TREE structure given a starting point and the shapes to validate against -->
  <params>
    <var name="url" type="string" />
    <var name="rootShapes" type="list[map]" />
    <var name="nodeShapes" type="list[map]" />
    <var name="treeShapes" type="list[map]" />
    <var name="maxProcessedCount" type="number" />
  </params>
  <variables>
    <var name="nodesToProcess" type="list[string]" />
    <var name="processedNodes" type="list[string]" />
    <var name="memberShapes" type="list[map]" />
    <var name="treeNodes" type="list[string]" />
    <var name="contentTypes" type="list[string]" />
    <var name="done" type="boolean" />
  </variables>
  <steps>
    <log level="DEBUG">"Processing root node"</log>
    <!-- TODO: initialize correctly: https://treecg.github.io/specification/#init -->
    <call id="processNode" path="scriptlets/process-tree-node.xml">
      <input name="url">$url</input>
      <input name="nodeShapes">$rootShapes</input>
      <input name="nodesToProcess">$nodesToProcess</input>
      <input name="memberShapes">$memberShapes</input>
    </call>
    <assign to="nodesToProcess">$processNode{nodesToProcess}</assign>
    <assign to="treeNodes" append="true">$processNode{treeNode}</assign>
    <assign to="contentTypes" append="true">$processNode{contentType}</assign>
    <assign to="memberShapes">$processNode{memberShapes}</assign>
    <assign to="processedNodes" append="true">string($url)</assign>
    <log level="DEBUG">"Done processing root node"</log>

    <assign to="done">false()</assign>
    <while desc="Process other nodes">
      <cond>not($done)</cond>
      <do>
        <log level="DEBUG">"Getting next node to process"</log>
        <call id="getNextNode" path="scriptlets/get-next-node.xml">
          <input name="processedNodes">$processedNodes</input>
          <input name="nodesToProcess">$nodesToProcess</input>
          <input name="maxProcessedCount">$maxProcessedCount</input>
        </call>
        <assign to="nodesToProcess">$getNextNode{nodesToProcess}</assign>
        <assign to="url">$getNextNode{url}</assign>
        <assign to="done">$getNextNode{done}</assign>
        <log level="DEBUG">"Done getting next node to process"</log>

        <if hidden="true">
          <cond>not($done)</cond>
          <then hidden="false">
            <log level="DEBUG">"Processing next node"</log>
            <call id="processNode" path="scriptlets/process-tree-node.xml">
              <input name="url">$url</input>
              <input name="nodeShapes">$nodeShapes</input>
              <input name="nodesToProcess">$nodesToProcess</input>
              <input name="memberShapes">$memberShapes</input>
            </call>
            <assign to="nodesToProcess">$processNode{nodesToProcess}</assign>
            <assign to="treeNodes" append="true">$processNode{treeNode}</assign>
            <assign to="contentTypes" append="true">$processNode{contentType}</assign>
            <assign to="processedNodes" append="true">string($url)</assign>
            <log level="DEBUG">"Done processing next node"</log>
          </then>
        </if>
      </do>
    </while>

    <call id="validateTree" path="scriptlets/validate-tree.xml">
      <input name="treeNodes">$treeNodes</input>
      <input name="contentTypes">$contentTypes</input>
      <input name="treeShapes">$treeShapes</input>
    </call>
  </steps>
</scriptlet>